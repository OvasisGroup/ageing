// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

model User {
  id                  String      @id @default(cuid())
  username            String      @unique
  email               String      @unique
  password            String
  role                Role        @default(CUSTOMER)
  subRole             SubRole?
  
  // Email verification
  emailVerified       Boolean     @default(false)
  verificationToken   String?
  verificationTokenExpiry DateTime?
  
  // Common fields
  firstName           String?
  lastName            String?
  phone               String?
  address             String?
  zipCode             String?
  
  // Provider-specific fields
  businessName        String?
  businessAddress     String?
  licenseNumber       String?
  serviceType         String?     // Changed from enum to String to allow dynamic categories
  yearsOfExperience   Int?
  description         String?     @db.Text
  
  // Profile fields
  profilePhoto        String?
  vettedStatus        VettedStatus @default(NOT_VETTED)
  vettedAt            DateTime?
  vettedBy            String?
  
  // Insurance Information
  insuranceProvider   String?
  insurancePolicyNumber String?
  insuranceExpiryDate DateTime?
  insuranceDocuments  String[]    @default([])
  
  // Workers Compensation Insurance
  workersCompProvider String?
  workersCompPolicyNumber String?
  workersCompExpiryDate DateTime?
  workersCompDocuments String[]   @default([])
  
  // Certifications
  certifications      Json[]      @default([])
  
  // Google Calendar Integration
  googleCalendarRefreshToken String?
  googleCalendarAccessToken  String?
  googleCalendarTokenExpiry  DateTime?
  
  // SubRole relationships
  parentUserId        String?
  parentUser          User?       @relation("UserSubRoles", fields: [parentUserId], references: [id], onDelete: Cascade)
  subRoleUsers        User[]      @relation("UserSubRoles")
  
  // Booking relationships
  customerBookings    Booking[]   @relation("CustomerBookings")
  providerBookings    Booking[]   @relation("ProviderBookings")
  
  // SubRole permissions
  permissions         String[]    @default([])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

enum Role {
  CUSTOMER
  PROVIDER
  ADMIN
}

enum SubRole {
  FAMILY_MEMBER
  CAREGIVER
}

enum VettedStatus {
  NOT_VETTED
  PENDING_REVIEW
  VETTED
  REJECTED
}

model NewsletterSubscription {
  id          String   @id @default(cuid())
  email       String   @unique
  name        String?
  isActive    Boolean  @default(true)
  subscribedAt DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("newsletter_subscriptions")
}

model Inquiry {
  id        String          @id @default(cuid())
  name      String
  email     String
  phone     String
  subject   String
  message   String          @db.Text
  status    InquiryStatus   @default(PENDING)
  priority  InquiryPriority @default(MEDIUM)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  @@map("inquiries")
}

enum InquiryStatus {
  PENDING
  REVIEWED
  RESPONDED
  CLOSED
}

enum InquiryPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model Category {
  id            String        @id @default(cuid())
  title         String
  description   String?       @db.Text
  image         String?
  slug          String        @unique
  isActive      Boolean       @default(true)
  subcategories Subcategory[]
  bookings      Booking[]     // Relation to bookings
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@map("categories")
}

model Subcategory {
  id          String   @id @default(cuid())
  title       String
  description String?  @db.Text
  image       String?
  slug        String   @unique
  isActive    Boolean  @default(true)
  categoryId  String
  category    Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("subcategories")
}

model Booking {
  id                String        @id @default(cuid())
  customerId        String
  customer          User          @relation("CustomerBookings", fields: [customerId], references: [id], onDelete: Cascade)
  providerId        String
  provider          User          @relation("ProviderBookings", fields: [providerId], references: [id], onDelete: Cascade)
  categoryId        String        // Link to Category instead of enum
  category          Category      @relation(fields: [categoryId], references: [id])
  title             String
  description       String?       @db.Text
  startTime         DateTime
  endTime           DateTime
  duration          Int           // Duration in minutes
  status            BookingStatus @default(PENDING)
  budget            Float?        // Budget amount for the service
  googleEventId     String?       // Google Calendar Event ID
  location          String?
  notes             String?       @db.Text
  cancellationReason String?     @db.Text
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@map("bookings")
}

enum BookingStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}
